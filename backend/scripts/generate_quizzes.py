from __future__ import annotations
import sys
import os
import pathlib
import uuid
from sqlalchemy import select, delete
from app.db.session import SessionLocal
from app.models.module import Module, Submodule
from app.models.quiz import Quiz, Question, QuestionType, QuizType

# Add current directory to PYTHONPATH
sys.path.append("/app")
sys.path.append(os.getcwd())

QUIZ_DATA = {
    "1. Технология построения бизнеса по франшизе Каркас Тайги": [
        {"q": "В чем заключается основная миссия компании Каркас Тайги?", "a": "Создание качественного и доступного жилья по технологии CLT"},
        {"q": "Какое ключевое преимущество технологии CLT упоминается в материале?", "a": "Экологичность и скорость сборки"},
        {"q": "Кто является целевой аудиторией франшизы?", "a": "Предприниматели, желающие развивать строительный бизнес"},
        {"q": "Что входит в пакет поддержки франчайзи?", "a": "Обучение, маркетинг и технологические карты"},
        {"q": "Какова география присутствия бренда согласно стратегии?", "a": "Вся территория РФ и СНГ"},
        {"q": "Какое основное требование к производственной площадке?", "a": "Наличие крытого цеха и подъездных путей"}
    ],
    "2. Оргструктура": [
        {"q": "Кто стоит во главе организационной структуры?", "a": "Генеральный директор"},
        {"q": "Какой отдел отвечает за контроль качества материалов?", "a": "ОТК (Отдел технического контроля)"},
        {"q": "К какому департаменту относятся проектировщики?", "a": "Проектно-конструкторское бюро"},
        {"q": "Какую роль выполняет менеджер проекта?", "a": "Координация всех этапов строительства от договора до сдачи"},
        {"q": "Какая структура используется в компании: иерархическая или матричная?", "a": "Иерархическая с элементами функционального взаимодействия"},
        {"q": "За что отвечает отдел снабжения?", "a": "Своевременная закупка и доставка материалов на объекты"}
    ],
    "3. Телеграмм группы": [
        {"q": "Какая группа является основной для оперативного общения?", "a": "Общий чат команды"},
        {"q": "В какой группе публикуются новости компании?", "a": "Инфоканал Каркас Тайги"},
        {"q": "Куда нужно отправлять отчеты о проделанной работе?", "a": "В специализированный чат отчетов"},
        {"q": "Как называется группа для обмена опытом между партнерами?", "a": "Клуб партнеров"},
        {"q": "Что запрещено делать в рабочих чатах согласно регламенту?", "a": "Спам, флуд и неконструктивная критика"},
        {"q": "Где можно найти библиотеку знаний и документов?", "a": "В боте базы знаний или закрепленных сообщениях"}
    ],
    "4. Регламент участия в видеовстречах": [
        {"q": "Какое минимальное требование к внешнему виду участника?", "a": "Опрятный вид, соответствующий деловой этике"},
        {"q": "За сколько минут до начала нужно подключиться к встрече?", "a": "За 2-3 минуты"},
        {"q": "Нужно ли включать камеру во время встречи?", "a": "Да, камера должна быть включена по умолчанию"},
        {"q": "Как обозначить желание высказаться?", "a": "Использовать функцию 'Поднять руку'"},
        {"q": "Где должны находиться участники во время планерки?", "a": "В тихом месте без посторонних шумов"},
        {"q": "Какое действие обязательно после завершения встречи?", "a": "Ознакомление с протоколом и выполнение поставленных задач"}
    ],
    "5. Что такое франшиза": [
        {"q": "Что такое паушальный взнос?", "a": "Единоразовый платеж за право входа в сеть"},
        {"q": "Что такое роялти?", "a": "Ежемесячные отчисления за пользование брендом и поддержку"},
        {"q": "Что передает франчайзер партнеру?", "a": "Право использования бренда и бизнес-модели"},
        {"q": "В чем главное преимущество покупки франшизы перед запуском с нуля?", "a": "Использование проверенной бизнес-модели и минимизация рисков"},
        {"q": "Кто несет ответственность за операционную деятельность партнера?", "a": "Сам партнер (франчайзи)"},
        {"q": "Может ли партнер менять технологию строительства CLT?", "a": "Нет, строгое соблюдение технологии обязательно"}
    ],
    "6. Об обучении": [
        {"q": "Какова цель системы обучения LMS?", "a": "Стандартизация знаний и быстрая адаптация сотрудников"},
        {"q": "Как подтверждается изучение материала?", "a": "Нажатием кнопки 'Прочитал' и прохождением квиза"},
        {"q": "Каков проходной балл для успешной сдачи квиза?", "a": "70%"},
        {"q": "Где можно увидеть свой прогресс?", "a": "В личном кабинете и на главной странице модуля"},
        {"q": "Что происходит при неудачной сдаче квиза?", "a": "Необходимо повторно изучить материал и пересдать"},
        {"q": "Как часто обновляются обучающие материалы?", "a": "По мере изменения регламентов и технологий компании"}
    ]
}

def generate_quizzes():
    with SessionLocal() as db:
        # Get module "Старт"
        module = db.scalar(select(Module).where(Module.title == "Старт"))
        if not module:
            print("Module 'Старт' not found")
            return

        submodules = db.scalars(select(Submodule).where(Submodule.module_id == module.id).order_by(Submodule.order)).all()
        
        for sub in submodules:
            # Find matching quiz data by title
            questions_data = None
            for key in QUIZ_DATA:
                if key.lower() in sub.title.lower():
                    questions_data = QUIZ_DATA[key]
                    break
            
            if not questions_data:
                print(f"No questions for submodule: {sub.title}")
                continue
            
            # Update quiz type
            quiz = db.get(Quiz, sub.quiz_id)
            if quiz:
                quiz.type = QuizType.submodule
                quiz.pass_threshold = 70
            
            # Get existing questions to avoid integrity errors
            existing_questions = db.scalars(select(Question).where(Question.quiz_id == sub.quiz_id)).all()
            
            # Update existing or add new
            for i, q_data in enumerate(questions_data):
                if i < len(existing_questions):
                    # Update existing
                    q = existing_questions[i]
                    q.prompt = q_data["q"]
                    q.correct_answer = q_data["a"]
                else:
                    # Add new
                    db.add(Question(
                        quiz_id=sub.quiz_id,
                        type=QuestionType.single,
                        difficulty=1,
                        prompt=q_data["q"],
                        correct_answer=q_data["a"],
                        concept_tag=f"start_{sub.order}",
                    ))
            
            print(f"Processed {len(questions_data)} questions for: {sub.title}")
        
        db.commit()

if __name__ == "__main__":
    generate_quizzes()
